{% extends 'base.html' %}
{% block content %}
<br><br>
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
                <i class="bi bi-clipboard-data"></i> {{ job_card.job_card_number }}
            </h3>
            <div class="btn-group">
                {% if job_card.acknowledged == False and user in job_card.assigned_users.all %}
                <a href="{% url 'job_card_acknowledge' job_card.pk %}" class="btn btn-light btn-sm">
                   <i class="bi bi-check-circle"></i> Acknowledge
                </a>
                {% endif %}
                 {% if user.is_superuser %}
                <a href="{% url 'job_card_update' job_card.pk %}" class="btn btn-light btn-sm">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                {% endif %}
                <a href="{% url 'job_card_list' %}" class="btn btn-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>
        
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <h5 class="text-muted"><i class="bi bi-card-text"></i> Task Description</h5>
                        <p class="lead">{{ job_card.task_description }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <h5 class="text-muted"><i class="bi bi-geo-alt"></i> Location</h5>
                        <p>{{ job_card.location|default:"Not specified" }}</p>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <h5 class="text-muted"><i class="bi bi-person-circle"></i> Assigned Users</h5>
                        <div class="list-group">
                            {% for user in job_card.assigned_users.all %}
                            <div class="list-group-item">
                                <i class="bi bi-person"></i> {{ user.get_full_name|default:user.username }}
                            </div>
                            {% empty %}
                            <div class="list-group-item text-muted">No users assigned</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Status</h6>
                            <span class="badge {% if job_card.status == 'Completed' %}bg-success
                                             {% elif job_card.status == 'In Progress' %}bg-primary
                                             {% elif job_card.status == 'On Hold' %}bg-warning
                                             {% elif job_card.status == 'Rejected' %}bg-danger
                                             {% else %}bg-secondary{% endif %} fs-6">
                                {{ job_card.status }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Priority Level</h6>
                            <span class="badge {% if job_card.priority_level == 'High' %}bg-danger
                                             {% elif job_card.priority_level == 'Medium' %}bg-warning
                                             {% else %}bg-info{% endif %} fs-6">
                                {{ job_card.priority_level }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Maintenance Type</h6>
                            <span class="badge bg-secondary fs-6">{{ job_card.maintenance_type }}</span>
                        </div>
                    </div>
                </div>
            </div>
             <div class="row mt-3">
                    <div class="col-md-12">
                       <div class="card bg-light">
                           <div class="card-body">
                             <h6 class="card-title text-muted">Acknowledgement Status</h6>
                            {% if job_card.acknowledged %}
                            <span class="badge bg-success fs-6">Acknowledged</span>
                            <p class="mt-1">Acknowledged At: {{ job_card.acknowledged_at }}</p>
                                {% if job_card.time_to_acknowledge %}
                                    <p class="mt-1">Time to Acknowledge: {{ job_card.time_to_acknowledge }}</p>
                                {% endif %}
                             {% else %}
                             <span class="badge bg-danger fs-6">Not Acknowledged</span>
                            {% endif %}

                           </div>
                         </div>
                    </div>
                </div>
            
            
             {% if user in job_card.assigned_users.all %}
             <div class="row mt-4">
                 <div class="col-12">
                    <div class="card bg-light">
                     <div class="card-body">
                         <h5 class="text-muted"><i class="bi bi-gear"></i> Update Status & Remarks</h5>
                             <form method="POST" action="{% url 'job_card_update_status' job_card.pk %}">
                                 {% csrf_token %}
                                 <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                        <select name="status" id="status" class="form-select">
                                            {% for choice in job_card.STATUS_CHOICES %}
                                                <option value="{{ choice.0 }}" {% if job_card.status == choice.0 %}selected{% endif %}>
                                                    {{ choice.1 }}
                                                </option>
                                            {% endfor %}
                                         </select>
                                 </div>
                                <div class="mb-3">
                                    <label for="remarks" class="form-label">Remarks</label>
                                    <textarea name="remarks" id="remarks" class="form-control">{{ job_card.remarks|default:"" }}</textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Update</button>
                           </form>
                        </div>
                    </div>
                 </div>
              </div>
             {% endif %}
              {% if job_card.status == 'Completed' %}
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                <h6 class="card-title text-muted">Completion time</h6>
                                 
                                  {% if job_card.time_to_complete %}
                                        <p>Time to complete : {{ job_card.time_to_complete }}</p>
                                   {% endif %}
                                
                                </div>
                            </div>
                        </div>
                   </div>
                 {% endif %}

            <div class="mt-4">
                <h5 class="text-muted"><i class="bi bi-clock-history"></i> Timeline</h5>
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-calendar-plus"></i> Created</span>
                            <small class="text-muted">{{ job_card.created_at|date:"F j, Y, g:i a" }}</small>
                        </div>
                        <small class="text-muted">by {{ job_card.created_by.get_full_name|default:job_card.created_by.username }}</small>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-calendar-check"></i> Last Updated</span>
                            <small class="text-muted">{{ job_card.updated_at|date:"F j, Y, g:i a" }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}